service: poker
org: edwardhorsey
app: poker

custom:
  currentStage: ${opt:stage, self:provider.stage}
  lambdaRunTime: python3.8
  pokerConnections: pokerConnections-${self:custom.currentStage}
  pokerGames: pokerGames-${self:custom.currentStage}
  pokerPastGames: pokerPastGames-${self:custom.currentStage}
  pokerTable: pokerTable-${self:custom.currentStage}

provider:
  name: aws
  iamManagedPolicies:
    - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
  runtime: ${self:custom.lambdaRunTime}
  versionFunctions: false
  region: eu-west-1
  timeout: 29

plugins:
  - serverless-dotenv-plugin
  - serverless-pseudo-parameters
  - serverless-offline
package:
  individually: true
  exclude:
    - "lib/**"
    - "node_modules/**"

layers:
  pythonPackageLayer:
    path: lib
    name: Python-Package-layer
    description: Python Package layer
    compatibleRuntimes:
      - ${self:custom.lambdaRunTime}

functions:
  connectHandler:
    handler: connect_handler.handle
    events:
      - websocket: $connect
    layers:
      - { Ref: PythonPackageLayerLambdaLayer }
    environment:
      POKER_CONNECTIONS_TABLE_NAME: ${self:custom.pokerConnections}
      POKER_TABLE_NAME: ${self:custom.pokerTable}

  disconnectHandler:
    handler: disconnect_handler.handle
    events:
      - websocket: $disconnect
    layers:
      - { Ref: PythonPackageLayerLambdaLayer }
    environment:
      POKER_CONNECTIONS_TABLE_NAME: ${self:custom.pokerConnections}
      POKER_TABLE_NAME: ${self:custom.pokerTable}

  gameActionHandler:
    handler: game_action_handler.handle
    events:
      - websocket:
          route: onGameAction
    layers:
      - { Ref: PythonPackageLayerLambdaLayer }
    environment:
      POKER_CONNECTIONS_TABLE_NAME: ${self:custom.pokerConnections}
      POKER_GAMES_TABLE_NAME: ${self:custom.pokerGames}
      POKER_PAST_GAMES_TABLE_NAME: ${self:custom.pokerPastGames}
      POKER_TABLE_NAME: ${self:custom.pokerTable}

resources:
  Resources:
    pokerConnections:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.pokerConnections}
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
          - AttributeName: userToken
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        GlobalSecondaryIndexes:
        - IndexName: userTokenIndex
          KeySchema:
          - AttributeName: userToken
            KeyType: HASH
          Projection:
            ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        SSESpecification:
          SSEEnabled: true

    pokerGames:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.pokerGames}
        AttributeDefinitions:
          - AttributeName: gameId
            AttributeType: S
        KeySchema:
          - AttributeName: gameId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        SSESpecification:
          SSEEnabled: true

    pokerTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.pokerTable}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: userTokenPK
            AttributeType: S
          - AttributeName: userTokenSK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
        - IndexName: userToken
          KeySchema:
          - AttributeName: userTokenPK
            KeyType: HASH
          - AttributeName: userTokenSK
            KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY
        BillingMode: PAY_PER_REQUEST
        SSESpecification:
          SSEEnabled: true